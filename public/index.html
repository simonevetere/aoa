<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Firebase Form</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
</head>
<body class="container-fluid p-3">

  <div id="tasks" style="width: 10000px;" class="p-2 row m-0"></div>

  <script src="https://www.gstatic.com/firebasejs/7.22.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.22.0/firebase-firestore.js"></script>
  <script>
    // variables
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
	const firebaseConfig = {
	  apiKey: "AIzaSyDOR53gRsCW30xLiqazUZGp8Mm2euQF8go",
	  authDomain: "monviso-8d767.firebaseapp.com",
	  databaseURL: "https://monviso-8d767-default-rtdb.europe-west1.firebasedatabase.app",
	  projectId: "monviso-8d767",
	  storageBucket: "monviso-8d767.appspot.com",
	  messagingSenderId: "859501920236",
	  appId: "1:859501920236:web:050d08b3658c16f92dcac9",
	  measurementId: "G-E48JZDK5W7"
	};
    firebase.initializeApp(firebaseConfig);
    const firestore = firebase.firestore();
    const tasksDOM = document.getElementById('tasks');
    const taskInputDOM = document.getElementById('taskTitle');
    var anagrafica = [];

    // utility functions
    function cleanData(snapshots) {
      let data = [];
      snapshots.forEach(function(doc) {
        data.push({ id: doc.id, ...doc.data() });
      })
      document.getElementById('tasks').innerHTML = "";
      return data;
    }

    function cleanDataAnag(snapshots) {
      let data = [];
      snapshots.forEach(function(doc) {
        data.push({ id: doc.id, ...doc.data() });
      })
      document.getElementById('tasks').innerHTML = "";
      anagrafica = data[0];

      return data;
    }

    // form functions
    function handleCreate(event) {
      event.preventDefault();
      let task = {
        name: taskInputDOM.value,
        status: 'incomplete'
      }
      return firestore.collection('tasks').add(task)
      .then(ref => {
        task.id = ref.id;
        taskInputDOM.value = '';
        return createTask(task);
      })
    }

    function handleStatusUpdate(task) {
      let updatedTask = {
        name: task.name,
        status: 'complete'
      }
      return firestore.collection('tasks').doc(task.id).update(updatedTask)
      .then(ref => {
        document.getElementById(task.id).remove();
        return createTask(updatedTask);
      })
    }

    function handleDelete(id) {
      console.log(id);
      return firestore.collection('tasks').doc(id).delete()
      .then(ref => document.getElementById(id).remove())
    }

    function close(id){
      document.getElementById(id).remove()
      let updatedOrder = {
        stato: 'closed'
      }
      return firestore.collection('ordini').doc(id).update(updatedOrder)
      
    }
    // dom functions
    function createTask(task) {
      const toast = document.createElement('div');

      toast.innerHTML = '<div class="toast" style="opacity : 1; height: 300px; margin-left: 25px" role="alert" aria-live="assertive" aria-atomic="true"><div class="toast-header"><strong class="mr-auto">tavolo: ' +task.tavolo + ' ' + task.iduser +'\xa0\xa0\xa0'+' </strong><small class="text-muted">' + task.data + '</small></div><div id="tasks" class="toast-body">' + task.desc+ '</div></div>';
      
      toast.setAttribute('id', task.id);
      toast.addEventListener("click", (e) => this.close(task.id));
      tasksDOM.append(toast);
    }

    // firebase functions
    function fetchTasks() {

      return firestore.collection('ordini').where("stato", "==", "open").where("idanag", "==", anagrafica.nome).get()
      .then(snapshots => cleanData(snapshots))
      .then(tasks => tasks.map(task => createTask(task)))
    };

    function getUrlParameter(sParam) {
    var sPageURL = window.location.search.substring(1),
        sURLVariables = sPageURL.split('&'),
        sParameterName,
        i;
      read_object(sURLVariables);

        return sURLVariables;
    };

    function read_object(object_all_params){
      first_access = is_first_access(object_all_params);
      if(first_access){
        add_url_params("tour=0");
      }
      for(param in object_all_params){
          console.log(object_all_params[param].indexOf("idanag"));
        if(object_all_params[param].indexOf("idanag") > -1){
          const idanag = object_all_params[param].substring( object_all_params[param].indexOf("=")).substring(1);
          return firestore.collection('anagrafica').where("codice_cliente", "==", idanag).get()
          .then(snapshots => cleanDataAnag(snapshots))
        } 
      }
    }

    function is_first_access(object_all_params){
      if(JSON.stringify(object_all_params).indexOf('tour') >= 0){
        return false;
      } else {
        return true;
      }
    }

    function add_url_params(params){
      window.location.search = window.location.search + "&" + params;
    }

    
    getUrlParameter();
    setInterval('fetchTasks()', 2000);
  </script>
</body>
</html>